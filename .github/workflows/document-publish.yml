name: Publish approved PDF to SharePoint (with metadata + hash)

on:
  push:
    branches:
      - main
    paths:
      - "docs/*.pdf"

jobs:
  publish_pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools (hash + PDF metadata)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
          sudo apt-get install -y libimage-exiftool-perl  # exiftool

      # 1. Находим целевой PDF
      - name: Detect target PDF
        id: changed
        run: |
          # Сначала пытаемся найти изменённые pdf в этом коммите
          FILES=$(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA | grep "^docs/.*\.pdf$" || true)

          if [ -z "$FILES" ]; then
            echo "No changed PDFs detected in commit. Fallback to any PDF in docs/."
            FILES=$(ls docs/*.pdf 2>/dev/null || true)
          fi

          if [ -z "$FILES" ]; then
            echo "No PDF files found in docs/. Nothing to publish."
            exit 0
          fi

          echo "PDF candidates:"
          echo "$FILES"

          FIRST=$(echo "$FILES" | head -n 1)
          echo "Using PDF: $FIRST"
          echo "pdf=$FIRST" >> $GITHUB_OUTPUT

      # 2. Вынимаем ID документа и версию (из md)
      - name: Extract document metadata (ID + version)
        if: ${{ steps.changed.outputs.pdf != '' }}
        id: meta
        run: |
          PDF_PATH="${{ steps.changed.outputs.pdf }}"
          echo "PDF_PATH=$PDF_PATH"

          FILENAME=$(basename "$PDF_PATH")        # напр. SOP-ITSM-000-Hello-World.pdf
          BASENAME="${FILENAME%.pdf}"             # SOP-ITSM-000-Hello-World

          # ID документа: первые три блока через дефис -> SOP-ITSM-000
          DOC_ID=$(echo "$BASENAME" | cut -d'-' -f1-3)

          # Связанный md-файл: docs/SOP-ITSM-000-Hello-World.md
          MD_FILE="docs/${BASENAME}.md"
          VERSION="0.0"

          if [ -f "$MD_FILE" ]; then
            # Ищем строку вида "version: 0.2" (фронтматтер или обычная)
            FOUND=$(grep -iE "^version:" "$MD_FILE" | head -n 1 | awk '{print $2}')
            if [ -n "$FOUND" ]; then
              VERSION="$FOUND"
            fi
          fi

          echo "DOC_ID=$DOC_ID"
          echo "VERSION=$VERSION"
          echo "BASENAME=$BASENAME"

          echo "doc_id=$DOC_ID" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "basename=$BASENAME" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      # 3. Считаем SHA256 и вписываем метаданные в PDF
      - name: Compute SHA256 and embed metadata into PDF
        if: ${{ steps.changed.outputs.pdf != '' }}
        id: sign
        run: |
          PDF_PATH="${{ steps.changed.outputs.pdf }}"
          DOC_ID="${{ steps.meta.outputs.doc_id }}"
          VERSION="${{ steps.meta.outputs.version }}"

          # SHA256
          SHA256=$(sha256sum "$PDF_PATH" | awk '{print $1}')
          SHA_SHORT=$(echo $GITHUB_SHA | cut -c1-8)
          NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          APPROVER="${{ github.actor }}"

          echo "SHA256=$SHA256"
          echo "APPROVER=$APPROVER"
          echo "TIME=$NOW"

          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

          # Метаданные PDF:
          # Title:   SOP-XXX vY.Y
          # Subject: Approved SOP document
          # Author:  <github.actor>
          # Keywords: APPROVED;DOC_ID=...;VERSION=...;SHA256=...;COMMIT=...;...
          TITLE="${DOC_ID} v${VERSION}"
          SUBJECT="Approved SOP document"
          KEYWORDS="APPROVED;DOC_ID=${DOC_ID};VERSION=${VERSION};SHA256=${SHA256};COMMIT=${SHA_SHORT};PUBLISHED_AT=${NOW};PUBLISHED_BY=${APPROVER}"

          exiftool -overwrite_original \
            -Title="$TITLE" \
            -Subject="$SUBJECT" \
            -Author="$APPROVER" \
            -Keywords="$KEYWORDS" \
            "$PDF_PATH"

          # Создаём отдельный .sha256 файл (не коммитим, только для upload)
          HASH_FILE="docs/${DOC_ID}-v${VERSION}-approved.sha256"
          {
            echo "Document=${DOC_ID}-v${VERSION}-approved.pdf"
            echo "SHA256=${SHA256}"
            echo "Commit=${GITHUB_SHA}"
            echo "PublishedBy=${APPROVER}"
            echo "PublishedAt=${NOW}"
          } > "$HASH_FILE"

          echo "hash_file=$HASH_FILE" >> $GITHUB_OUTPUT

      # 4. Заливаем PDF и .sha256 в SharePoint (без overwrite)
      - name: Upload PDF and .sha256 to SharePoint
        if: ${{ steps.changed.outputs.pdf != '' }}
        env:
          SP_SITE_URL: ${{ secrets.SP_SITE_URL }}
          SP_DOC_LIBRARY: ${{ secrets.SP_DOC_LIBRARY }}
          SP_ROOT_FOLDER: ${{ secrets.SP_ROOT_FOLDER }}
          SP_USERNAME: ${{ secrets.SP_USERNAME }}
          SP_PASSWORD: ${{ secrets.SP_PASSWORD }}
        run: |
          PDF_PATH="${{ steps.changed.outputs.pdf }}"
          DOC_ID="${{ steps.meta.outputs.doc_id }}"
          VERSION="${{ steps.meta.outputs.version }}"
          HASH_FILE="${{ steps.sign.outputs.hash_file }}"

          TARGET_FOLDER="${SP_ROOT_FOLDER}/${DOC_ID}"
          TARGET_PDF="${DOC_ID}-v${VERSION}-approved.pdf"
          TARGET_HASH="${DOC_ID}-v${VERSION}-approved.sha256"

          echo "Will upload:"
          echo "  PDF : $PDF_PATH  → $TARGET_PDF"
          echo "  HASH: $HASH_FILE → $TARGET_HASH"
          echo "  Folder: $TARGET_FOLDER"

          FOLDER_ENCODED=$(echo "${SP_DOC_LIBRARY}/${TARGET_FOLDER}" | sed 's/ /%20/g')

          # 1) PDF. overwrite=false — НЕ перезаписывает существующий approved
          curl --silent --show-error --fail \
            --user "$SP_USERNAME:$SP_PASSWORD" \
            -X POST \
            -H "accept: application/json;odata=verbose" \
            -H "content-type: application/octet-stream" \
            --data-binary @"$PDF_PATH" \
            "${SP_SITE_URL}/_api/web/GetFolderByServerRelativeUrl('${FOLDER_ENCODED}')/Files/add(url='${TARGET_PDF}',overwrite=false)"

          echo "PDF upload complete."

          # 2) .sha256. Тоже без overwrite — каждая версия уникальна
          curl --silent --show-error --fail \
            --user "$SP_USERNAME:$SP_PASSWORD" \
            -X POST \
            -H "accept: application/json;odata=verbose" \
            -H "content-type: text/plain" \
            --data-binary @"$HASH_FILE" \
            "${SP_SITE_URL}/_api/web/GetFolderByServerRelativeUrl('${FOLDER_ENCODED}')/Files/add(url='${TARGET_HASH}',overwrite=false)"

          echo "SHA256 file upload complete."
