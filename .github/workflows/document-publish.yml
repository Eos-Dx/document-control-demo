name: Send approved PDF to DocuSign (JWT)

on:
  push:
    branches:
      - main
    paths:
      - "docs/*.pdf"

jobs:
  send_to_docusign:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. Находим целевой PDF (берём первый изменённый в docs/)
      - name: Find target PDF
        id: pdf
        run: |
          FILES=$(git diff-tree --no-commit-id --name-only -r "$GITHUB_SHA" | grep "^docs/.*\.pdf$" || true)

          if [ -z "$FILES" ]; then
            echo "No changed PDFs detected in this commit. Nothing to send."
            exit 0
          fi

          echo "Changed PDFs:"
          echo "$FILES"

          FIRST=$(echo "$FILES" | head -n 1)
          echo "Using PDF: $FIRST"
          echo "path=$FIRST" >> "$GITHUB_OUTPUT"

      # 2. Делаем JWT и получаем access_token по JWT Grant
      - name: Get DocuSign access token via JWT
        if: ${{ steps.pdf.outputs.path != '' }}
        id: jwt
        env:
          DOCUSIGN_INTEGRATION_KEY: ${{ secrets.DOCUSIGN_INTEGRATION_KEY }}
          DOCUSIGN_USER_ID:        ${{ secrets.DOCUSIGN_USER_ID }}
          DOCUSIGN_AUTH_SERVER:    ${{ secrets.DOCUSIGN_AUTH_SERVER }}
          DOCUSIGN_PRIVATE_KEY:    ${{ secrets.DOCUSIGN_PRIVATE_KEY }}
        run: |
          set -e

          INTEGRATION_KEY="$DOCUSIGN_INTEGRATION_KEY"
          USER_ID="$DOCUSIGN_USER_ID"
          AUTH_SERVER="$DOCUSIGN_AUTH_SERVER"
          PRIVATE_KEY_CONTENT="$DOCUSIGN_PRIVATE_KEY"

          # Сохраняем приватный ключ в файл
          echo "$PRIVATE_KEY_CONTENT" > private.key

          # Время жизни токена: 1 час
          NOW=$(date +%s)
          EXP=$((NOW + 3600))

          HEADER='{"alg":"RS256","typ":"JWT"}'
          PAYLOAD=$(cat <<EOF
{"iss":"$INTEGRATION_KEY","sub":"$USER_ID","aud":"$AUTH_SERVER","scope":"signature impersonation","exp":$EXP}
EOF
          )

          b64url() {
            # base64url без переноса строк и без '='
            openssl base64 -e -A | tr '+/' '-_' | tr -d '='
          }

          HEADER_B64=$(printf '%s' "$HEADER" | b64url)
          PAYLOAD_B64=$(printf '%s' "$PAYLOAD" | b64url)
          DATA="$HEADER_B64.$PAYLOAD_B64"

          SIGNATURE=$(printf '%s' "$DATA" \
            | openssl dgst -sha256 -sign private.key \
            | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')

          JWT="$DATA.$SIGNATURE"

          echo "Requesting access token from DocuSign JWT endpoint..."

          # Нужен jq для парсинга JSON
          sudo apt-get update >/dev/null
          sudo apt-get install -y jq >/dev/null

          RESPONSE=$(curl --silent --show-error --fail \
            --request POST \
            --url "https://${AUTH_SERVER}/oauth/token" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${JWT}")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Failed to obtain access token:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "::add-mask::$ACCESS_TOKEN"
          echo "token=$ACCESS_TOKEN" >> "$GITHUB_OUTPUT"

      # 3. Кодируем PDF в base64
      - name: Prepare PDF as base64
        if: ${{ steps.pdf.outputs.path != '' }}
        id: b64
        run: |
          PDF_PATH="${{ steps.pdf.outputs.path }}"
          echo "PDF_PATH=$PDF_PATH"

          B64=$(base64 -w0 "$PDF_PATH")
          FILENAME=$(basename "$PDF_PATH")

          echo "b64=$B64" >> "$GITHUB_OUTPUT"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"

      # 4. Отправляем конверт в DocuSign
      - name: Send envelope to DocuSign
        if: ${{ steps.pdf.outputs.path != '' }}
        env:
          DOCUSIGN_BASE_URI:   ${{ secrets.DOCUSIGN_BASE_URI }}
          DOCUSIGN_ACCOUNT_ID: ${{ secrets.DOCUSIGN_ACCOUNT_ID }}
          DOCUSIGN_SIGNER_EMAIL: ${{ secrets.DOCUSIGN_SIGNER_EMAIL }}
          DOCUSIGN_SIGNER_NAME:  ${{ secrets.DOCUSIGN_SIGNER_NAME }}
        run: |
          ACCESS_TOKEN="${{ steps.jwt.outputs.token }}"
          B64="${{ steps.b64.outputs.b64 }}"
          FILENAME="${{ steps.b64.outputs.filename }}"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "No access token from JWT step. Aborting."
            exit 1
          fi

          echo "Creating envelope in DocuSign for $FILENAME"

          read -r -d '' BODY <<EOF
          {
            "emailSubject": "Please sign: $FILENAME",
            "documents": [
              {
                "documentBase64": "$B64",
                "name": "$FILENAME",
                "fileExtension": "pdf",
                "documentId": "1"
              }
            ],
            "recipients": {
              "signers": [
                {
                  "email": "${DOCUSIGN_SIGNER_EMAIL}",
                  "name": "${DOCUSIGN_SIGNER_NAME}",
                  "recipientId": "1",
                  "routingOrder": "1"
                }
              ]
            },
            "status": "sent"
          }
          EOF

          curl --silent --show-error --fail \
            --request POST \
            --url "${DOCUSIGN_BASE_URI}/restapi/v2.1/accounts/${DOCUSIGN_ACCOUNT_ID}/envelopes" \
            --header "Authorization: Bearer ${ACCESS_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$BODY"

          echo "Envelope sent to DocuSign."
