name: Send approved PDF to DocuSign (JWT)

on:
  push:
    branches:
      - main
    paths:
      - "docs/*.pdf"

jobs:
  send_to_docusign:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Find changed PDF
        id: pdf
        run: |
          FILES=$(git diff-tree --no-commit-id --name-only -r "$GITHUB_SHA" | grep "^docs/.*\.pdf$" || true)

          if [ -z "$FILES" ]; then
            echo "No changed PDFs detected in this commit. Nothing to send."
            exit 0
          fi

          echo "Changed PDFs:"
          echo "$FILES"

          FIRST=$(echo "$FILES" | head -n 1)
          echo "Using PDF: $FIRST"
          echo "path=$FIRST" >> "$GITHUB_OUTPUT"

      - name: Prepare PDF as base64
        if: ${{ steps.pdf.outputs.path != '' }}
        id: b64
        run: |
          PDF_PATH="${{ steps.pdf.outputs.path }}"
          echo "PDF_PATH=$PDF_PATH"

          B64=$(base64 -w0 "$PDF_PATH")
          FILENAME=$(basename "$PDF_PATH")

          echo "b64=$B64" >> "$GITHUB_OUTPUT"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"

      - name: Install Python deps for JWT
        if: ${{ steps.pdf.outputs.path != '' }}
        run: |
          python -m pip install --upgrade pip
          pip install pyjwt requests

      - name: Get DocuSign access token (JWT)
        if: ${{ steps.pdf.outputs.path != '' }}
        id: jwt
        env:
          DOCUSIGN_AUTH_SERVER: ${{ secrets.DOCUSIGN_AUTH_SERVER }}
          DOCUSIGN_INTEGRATION_KEY: ${{ secrets.DOCUSIGN_INTEGRATION_KEY }}
          DOCUSIGN_USER_ID: ${{ secrets.DOCUSIGN_USER_ID }}
          DOCUSIGN_PRIVATE_KEY: ${{ secrets.DOCUSIGN_PRIVATE_KEY }}
        run: |
          python - << 'PY'
          import os, time, json
          import jwt, requests

          integration_key = os.environ["DOCUSIGN_INTEGRATION_KEY"]
          user_id = os.environ["DOCUSIGN_USER_ID"]
          auth_server = os.environ["DOCUSIGN_AUTH_SERVER"]
          private_key = os.environ["DOCUSIGN_PRIVATE_KEY"].encode("utf-8")

          now = int(time.time())
          payload = {
              "iss": integration_key,
              "sub": user_id,
              "aud": auth_server,
              "iat": now,
              "exp": now + 3600,
              "scope": "signature"
          }

          token = jwt.encode(payload, private_key, algorithm="RS256")

          url = f"https://{auth_server}/oauth/token"
          resp = requests.post(
              url,
              data={
                  "grant_type": "urn:ietf:params:oauth:grant-type:jwt-bearer",
                  "assertion": token,
              },
          )
          resp.raise_for_status()
          access_token = resp.json()["access_token"]

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"access_token={access_token}\n")
          PY

      - name: Send envelope to DocuSign
        if: ${{ steps.pdf.outputs.path != '' }}
        env:
          DOCUSIGN_BASE_URI: ${{ secrets.DOCUSIGN_BASE_URI }}
          DOCUSIGN_ACCOUNT_ID: ${{ secrets.DOCUSIGN_ACCOUNT_ID }}
          DOCUSIGN_SIGNER_EMAIL: ${{ secrets.DOCUSIGN_SIGNER_EMAIL }}
          DOCUSIGN_SIGNER_NAME: ${{ secrets.DOCUSIGN_SIGNER_NAME }}
          ACCESS_TOKEN: ${{ steps.jwt.outputs.access_token }}
        run: |
          B64="${{ steps.b64.outputs.b64 }}"
          FILENAME="${{ steps.b64.outputs.filename }}"

          if [ -z "$B64" ]; then
            echo "No base64 content. Aborting."
            exit 1
          fi

          echo "Creating envelope in DocuSign for $FILENAME"

          read -r -d '' BODY <<EOF
          {
            "emailSubject": "Please sign: $FILENAME",
            "documents": [
              {
                "documentBase64": "$B64",
                "name": "$FILENAME",
                "fileExtension": "pdf",
                "documentId": "1"
              }
            ],
            "recipients": {
              "signers": [
                {
                  "email": "${DOCUSIGN_SIGNER_EMAIL}",
                  "name": "${DOCUSIGN_SIGNER_NAME}",
                  "recipientId": "1",
                  "routingOrder": "1"
                }
              ]
            },
            "status": "sent"
          }
          EOF

          curl --silent --show-error --fail \
            --request POST \
            --url "${DOCUSIGN_BASE_URI}/restapi/v2.1/accounts/${DOCUSIGN_ACCOUNT_ID}/envelopes" \
            --header "Authorization: Bearer ${ACCESS_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$BODY"

          echo "Envelope sent to DocuSign."
