name: Send approved PDF to DocuSign (JWT)

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - "docs/*.pdf"

jobs:
  send_to_docusign:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find changed PDF in this push
        id: pdf
        run: |
          set -e
          FILES=$(git diff-tree --no-commit-id --name-only -r "$GITHUB_SHA" | grep "^docs/.*\.pdf$" || true)

          if [ -z "$FILES" ]; then
            echo "ℹ️ No changed PDFs in docs/ for this commit. Nothing to send."
            exit 0
          fi

          echo "Changed PDFs:"
          echo "$FILES"

          FIRST=$(echo "$FILES" | head -n 1)
          echo "Using PDF: $FIRST"
          echo "path=$FIRST" >> "$GITHUB_OUTPUT"

      - name: Base64 encode PDF
        if: ${{ steps.pdf.outputs.path != '' }}
        id: b64
        run: |
          set -e
          PDF_PATH="${{ steps.pdf.outputs.path }}"
          echo "PDF_PATH=$PDF_PATH"

          B64=$(base64 -w0 "$PDF_PATH")
          FILENAME=$(basename "$PDF_PATH")

          echo "b64=$B64" >> "$GITHUB_OUTPUT"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"

      - name: Get DocuSign access token via JWT
        if: ${{ steps.pdf.outputs.path != '' }}
        id: token
        env:
          DOCUSIGN_AUTH_SERVER: ${{ secrets.DOCUSIGN_AUTH_SERVER }}
          DOCUSIGN_INTEGRATION_KEY: ${{ secrets.DOCUSIGN_INTEGRATION_KEY }}
          DOCUSIGN_USER_ID: ${{ secrets.DOCUSIGN_USER_ID }}
          DOCUSIGN_RSA_PRIVATE_KEY: ${{ secrets.DOCUSIGN_RSA_PRIVATE_KEY }}
        run: |
          set -e

          # Сохраняем приватный ключ во временный файл
          echo "Writing RSA private key to file..."
          printf '%s\n' "$DOCUSIGN_RSA_PRIVATE_KEY" > docusign_private.key

          # JWT заголовок и payload
          HEADER='{"alg":"RS256","typ":"JWT"}'

          NOW=$(date +%s)
          EXP=$((NOW + 3600)) # токен на 1 час

          # Для demo-окружения aud = account-d.docusign.com
          PAYLOAD=$(cat <<EOF
          {
            "iss": "${DOCUSIGN_INTEGRATION_KEY}",
            "sub": "${DOCUSIGN_USER_ID}",
            "aud": "account-d.docusign.com",
            "iat": ${NOW},
            "exp": ${EXP},
            "scope": "signature impersonation"
          }
          EOF
          )

          b64url() {
            openssl base64 -e -A | tr '+/' '-_' | tr -d '='
          }

          HEADER_B64=$(printf '%s' "$HEADER" | b64url)
          PAYLOAD_B64=$(printf '%s' "$PAYLOAD" | b64url)
          DATA="${HEADER_B64}.${PAYLOAD_B64}"

          SIG=$(printf '%s' "$DATA" | openssl dgst -sha256 -sign docusign_private.key | b64url)
          JWT="${DATA}.${SIG}"

          echo "Requesting access token from ${DOCUSIGN_AUTH_SERVER}..."
          RESP=$(curl --silent --show-error --fail \
            --request POST \
            --url "${DOCUSIGN_AUTH_SERVER}/oauth/token" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${JWT}")

          ACCESS_TOKEN=$(echo "$RESP" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Failed to obtain access token. Response:"
            echo "$RESP"
            exit 1
          fi

          echo "Access token obtained."
          echo "access_token=$ACCESS_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Send envelope to DocuSign
        if: ${{ steps.pdf.outputs.path != '' }}
        env:
          DOCUSIGN_BASE_URL: ${{ secrets.DOCUSIGN_BASE_URL }}
          DOCUSIGN_ACCOUNT_ID: ${{ secrets.DOCUSIGN_ACCOUNT_ID }}
          DOCUSIGN_SIGNER_EMAIL: ${{ secrets.DOCUSIGN_SIGNER_EMAIL }}
          DOCUSIGN_SIGNER_NAME: ${{ secrets.DOCUSIGN_SIGNER_NAME }}
        run: |
          set -e
          ACCESS_TOKEN="${{ steps.token.outputs.access_token }}"
          B64="${{ steps.b64.outputs.b64 }}"
          FILENAME="${{ steps.b64.outputs.filename }}"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "No access token available. Aborting."
            exit 1
          fi

          echo "Creating DocuSign envelope for $FILENAME..."

          read -r -d '' BODY <<EOF
          {
            "emailSubject": "Please sign: $FILENAME",
            "documents": [
              {
                "documentBase64": "$B64",
                "name": "$FILENAME",
                "fileExtension": "pdf",
                "documentId": "1"
              }
            ],
            "recipients": {
              "signers": [
                {
                  "email": "${DOCUSIGN_SIGNER_EMAIL}",
                  "name": "${DOCUSIGN_SIGNER_NAME}",
                  "recipientId": "1",
                  "routingOrder": "1"
                }
              ]
            },
            "status": "sent"
          }
          EOF

          curl --silent --show-error --fail \
            --request POST \
            --url "${DOCUSIGN_BASE_URL}/restapi/v2.1/accounts/${DOCUSIGN_ACCOUNT_ID}/envelopes" \
            --header "Authorization: Bearer ${ACCESS_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$BODY"

          echo "Envelope sent to DocuSign."
