name: Send approved PDF to DocuSign

on:
  pull_request:
    types:
      - closed
    branches:
      - master
      - main
  push:
    branches:
      - main
      - master
    paths:
      - "docs/*.pdf"

jobs:
  send_to_docusign:
    # выполняем только если PR действительно merged, а не просто closed
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      DOCUSIGN_ACCOUNT_ID: ${{ secrets.DOCUSIGN_ACCOUNT_ID }}
      DOCUSIGN_BASE_URI: ${{ secrets.DOCUSIGN_BASE_URI }}          # например https://demo.docusign.net
      DOCUSIGN_AUTH_SERVER: ${{ secrets.DOCUSIGN_AUTH_SERVER }}    # например https://account-d.docusign.com
      DOCUSIGN_INTEGRATION_KEY: ${{ secrets.DOCUSIGN_INTEGRATION_KEY }}
      DOCUSIGN_PRIVATE_KEY: ${{ secrets.DOCUSIGN_PRIVATE_KEY }}    # полный PEM с BEGIN/END
      DOCUSIGN_USER_ID: ${{ secrets.DOCUSIGN_USER_ID }}            # API User ID (GUID)
      DOCUSIGN_SIGNER_EMAIL: ${{ secrets.DOCUSIGN_SIGNER_EMAIL }}
      DOCUSIGN_SIGNER_NAME: ${{ secrets.DOCUSIGN_SIGNER_NAME }}

    steps:
      - name: Checkout merge commit
        uses: actions/checkout@v4
        with:
          # берём именно merge_commit_sha PR
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Find changed PDF in docs/
        id: pdf
        run: |
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          echo "MERGE_SHA=$MERGE_SHA"

          FILES=$(git diff-tree --no-commit-id --name-only -r "$MERGE_SHA" | grep "^docs/.*\.pdf$" || true)

          if [ -z "$FILES" ]; then
            echo "No changed PDFs in docs/ for this merge. Nothing to send."
            exit 0
          fi

          echo "Changed PDFs:"
          echo "$FILES"

          FIRST=$(echo "$FILES" | head -n 1)
          echo "Using PDF: $FIRST"
          echo "path=$FIRST" >> $GITHUB_OUTPUT

      - name: Base64-encode PDF
        if: ${{ steps.pdf.outputs.path != '' }}
        id: b64
        run: |
          PDF_PATH="${{ steps.pdf.outputs.path }}"
          echo "PDF_PATH=$PDF_PATH"

          B64=$(base64 -w0 "$PDF_PATH")
          FILENAME=$(basename "$PDF_PATH")

          echo "b64=$B64" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Build JWT and get access token
        if: ${{ steps.pdf.outputs.path != '' }}
        id: token
        run: |
          echo "Writing private key to file..."
          echo "$DOCUSIGN_PRIVATE_KEY" > private.key

          NOW=$(date +%s)
          EXP=$((NOW + 3600))

          HEADER='{"alg":"RS256","typ":"JWT"}'
          PAYLOAD=$(cat <<EOF
{"iss":"$DOCUSIGN_INTEGRATION_KEY","sub":"$DOCUSIGN_USER_ID","aud":"$DOCUSIGN_AUTH_SERVER","iat":$NOW,"exp":$EXP,"scope":"signature impersonation"}
EOF
)

          b64url() {
            openssl base64 -e -A | tr '+/' '-_' | tr -d '='
          }

          HEADER_B64=$(printf '%s' "$HEADER" | b64url)
          PAYLOAD_B64=$(printf '%s' "$PAYLOAD" | b64url)
          DATA="${HEADER_B64}.${PAYLOAD_B64}"

          SIGNATURE=$(printf '%s' "$DATA" | openssl dgst -sha256 -sign private.key | b64url)
          JWT="${DATA}.${SIGNATURE}"

          echo "Requesting access token from DocuSign..."

          RESPONSE=$(curl --silent --show-error --fail \
            --request POST \
            --url "${DOCUSIGN_AUTH_SERVER}/oauth/token" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${JWT}")

          echo "Token response: $RESPONSE"

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Failed to obtain access token."
            exit 1
          fi

          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: Send envelope with PDF to DocuSign
        if: ${{ steps.pdf.outputs.path != '' }}
        run: |
          ACCESS_TOKEN="${{ steps.token.outputs.access_token }}"
          B64="${{ steps.b64.outputs.b64 }}"
          FILENAME="${{ steps.b64.outputs.filename }}"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "No access token. Aborting."
            exit 1
          fi

          echo "Creating envelope in DocuSign for $FILENAME"

          read -r -d '' BODY <<EOF
          {
            "emailSubject": "Please sign: $FILENAME",
            "documents": [
              {
                "documentBase64": "$B64",
                "name": "$FILENAME",
                "fileExtension": "pdf",
                "documentId": "1"
              }
            ],
            "recipients": {
              "signers": [
                {
                  "email": "${DOCUSIGN_SIGNER_EMAIL}",
                  "name": "${DOCUSIGN_SIGNER_NAME}",
                  "recipientId": "1",
                  "routingOrder": "1"
                }
              ]
            },
            "status": "sent"
          }
EOF

          curl --silent --show-error --fail \
            --request POST \
            --url "${DOCUSIGN_BASE_URI}/restapi/v2.1/accounts/${DOCUSIGN_ACCOUNT_ID}/envelopes" \
            --header "Authorization: Bearer ${ACCESS_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$BODY"

          echo "Envelope sent to DocuSign."
