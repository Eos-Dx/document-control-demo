name: Document Build (DOCX â†’ MD + PDF â†’ PR)

on:
  push:
    branches-ignore:
      - main
    paths:
      - "incoming/*.docx"
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  build_doc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper archiving
          ref: ${{ github.head_ref }}  # Checkout the actual branch

      # Cache apt packages to speed up subsequent runs
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: pandoc texlive texlive-xetex texlive-latex-recommended texlive-latex-extra fonts-dejavu
          version: 1.0

      - name: Install dependencies (Pandoc + TeX + fonts)
        run: |
          # Packages are cached by previous step, this just ensures they're installed
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive \
            texlive-xetex \
            texlive-latex-recommended \
            texlive-latex-extra \
            fonts-dejavu

      - name: Verify installations
        run: |
          echo "Pandoc version: $(pandoc --version | head -n1)"
          echo "XeLaTeX version: $(xelatex --version | head -n1)"

      - name: Convert DOCX to MD and PDF
        id: convert
        run: |
          set -e

          mkdir -p docs archive

          CONVERTED=0

          for f in incoming/*.docx; do
            # Check if file exists (handles empty glob)
            if [ ! -f "$f" ]; then
              echo "No DOCX files found in incoming/"
              exit 0
            fi

            base=$(basename "$f" .docx)
            timestamp=$(date +%Y%m%d-%H%M%S)

            echo "Processing: $f"
            echo "Base name: $base"

            # Archive existing MD/PDF with timestamp
            if [ -f "docs/${base}.md" ]; then
              echo "Archiving existing docs/${base}.md"
              cp "docs/${base}.md" "archive/${base}-${timestamp}.md"
            fi
            if [ -f "docs/${base}.pdf" ]; then
              echo "Archiving existing docs/${base}.pdf"
              cp "docs/${base}.pdf" "archive/${base}-${timestamp}.pdf"
            fi

            # Generate Markdown (GitHub Flavored Markdown)
            echo "Converting to Markdown..."
            pandoc "$f" \
              -f docx \
              -t gfm \
              --wrap=preserve \
              -o "docs/${base}.md"

            # Generate PDF using xelatex (supports Unicode)
            echo "Converting to PDF..."
            pandoc "$f" \
              -o "docs/${base}.pdf" \
              --pdf-engine=xelatex \
              --variable geometry:margin=1in \
              --variable fontsize=11pt

            echo "âœ“ Converted: $base"
            CONVERTED=$((CONVERTED + 1))
          done

          echo "files_converted=$CONVERTED" >> "$GITHUB_OUTPUT"
          echo "Total files converted: $CONVERTED"

      - name: Create Pull Request
        if: steps.convert.outputs.files_converted > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: Automated DOCX â†’ MD/PDF conversion

            - Converted ${{ steps.convert.outputs.files_converted }} document(s)
            - Generated Markdown and PDF outputs
            - Archived previous versions with timestamp

            [skip ci]
          title: "ğŸ“„ Document Update: DOCX â†’ MD/PDF Conversion"
          body: |
            ## Automated Document Conversion

            This PR was automatically generated by the document build workflow.

            ### Changes
            - **Files Processed**: ${{ steps.convert.outputs.files_converted }}
            - **Generated**: Markdown (`.md`) and PDF (`.pdf`) in `docs/`
            - **Archived**: Previous versions in `archive/` with timestamp

            ### Review Checklist
            - [ ] Verify Markdown formatting is correct
            - [ ] Check PDF renders properly (especially Unicode characters)
            - [ ] Confirm document metadata (title, version, date)
            - [ ] Review any changes against source DOCX

            ### Next Steps
            After approval and merge to `main`, the PDF will be automatically sent to DocuSign for Part 11 compliant signatures.

            ---
            âš™ï¸ Generated by: `docx-to-md.yml` workflow
          branch: docs/auto-convert-${{ github.run_number }}
          base: main
          delete-branch: true
          labels: |
            documentation
            automated

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.convert.outputs.files_converted }}" -gt 0 ]; then
            echo "âœ… Conversion completed successfully"
            echo "ğŸ“ Files converted: ${{ steps.convert.outputs.files_converted }}"
            echo "ğŸ”€ Pull request will be created"
          else
            echo "â„¹ï¸ No DOCX files found or processed"
          fi