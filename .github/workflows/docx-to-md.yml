name: Document Build (DOCX ‚Üí MD + PDF)

on:
  push:
    branches-ignore:
      - main
    paths:
      - "incoming/*.docx"
  workflow_dispatch:

jobs:
  build_doc:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: pandoc texlive texlive-xetex texlive-latex-recommended texlive-latex-extra fonts-dejavu
          version: 1.0

      - name: Install dependencies (Pandoc + TeX + fonts)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive \
            texlive-xetex \
            texlive-latex-recommended \
            texlive-latex-extra \
            fonts-dejavu

      - name: Verify installations
        run: |
          echo "Pandoc version: $(pandoc --version | head -n1)"
          echo "XeLaTeX version: $(xelatex --version | head -n1)"

      - name: Convert DOCX to MD and PDF
        id: convert
        run: |
          set -e
          
          mkdir -p docs archive
          
          CONVERTED=0
          
          for f in incoming/*.docx; do
            if [ ! -f "$f" ]; then
              echo "No DOCX files found in incoming/"
              exit 0
            fi
            
            base=$(basename "$f" .docx)
            timestamp=$(date +%Y%m%d-%H%M%S)
            
            echo "Processing: $f"
            echo "Base name: $base"
            
            if [ -f "docs/${base}.md" ]; then
              echo "Archiving existing docs/${base}.md"
              cp "docs/${base}.md" "archive/${base}-${timestamp}.md"
            fi
            if [ -f "docs/${base}.pdf" ]; then
              echo "Archiving existing docs/${base}.pdf"
              cp "docs/${base}.pdf" "archive/${base}-${timestamp}.pdf"
            fi
            
            echo "Converting to Markdown..."
            pandoc "$f" \
              -f docx \
              -t gfm \
              --wrap=preserve \
              -o "docs/${base}.md"
            
            echo "Converting to PDF..."
            pandoc "$f" \
              -o "docs/${base}.pdf" \
              --pdf-engine=xelatex \
              --variable geometry:margin=1in \
              --variable fontsize=11pt
            
            echo "‚úì Converted: $base"
            CONVERTED=$((CONVERTED + 1))
          done
          
          echo "files_converted=$CONVERTED" >> "$GITHUB_OUTPUT"
          echo "Total files converted: $CONVERTED"

      - name: Commit and push to same branch
        if: steps.convert.outputs.files_converted > 0
        run: |
          git config user.name "doc-bot"
          git config user.email "doc-bot@example.com"
          
          git add docs/ archive/
          
          git commit -m "docs: Automated DOCX ‚Üí MD/PDF conversion

- Converted ${{ steps.convert.outputs.files_converted }} document(s)
- Generated Markdown and PDF outputs
- Archived previous versions with timestamp

[skip ci]"
          
          git push

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.convert.outputs.files_converted }}" -gt 0 ]; then
            echo "‚úÖ Conversion completed successfully"
            echo "üìù Files converted: ${{ steps.convert.outputs.files_converted }}"
            echo "üîÄ Changes pushed to current branch"
            echo ""
            echo "Next steps:"
            echo "1. Review the generated MD and PDF files"
            echo "2. Create a Pull Request manually when ready"
            echo "3. After PR is merged to main, DocuSign workflow will trigger"
          else
            echo "‚ÑπÔ∏è No DOCX files found or processed"
          fi
