name: Send approved PDF to DocuSign

on:
  push:
    branches:
      - main
    paths:
      - "docs/*.pdf"
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - "docs/*.pdf"
  workflow_dispatch:
    inputs:
...

jobs:
  send-to-docusign:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find latest approved PDF
        id: pdf
        run: |
          set -e

          echo "Searching for latest approved PDF..."

          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚, Ð³Ð´Ðµ Ð² PR Ð±Ñ‹Ð» label "approved"
          LAST_APPROVED_COMMIT=$(git log -1 --format="%H" --grep="\[approved\]")

          if [ -z "$LAST_APPROVED_COMMIT" ]; then
            echo "No approved PDF found."
            echo "path=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found approved commit: $LAST_APPROVED_COMMIT"

          # Ð˜Ñ‰ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ðµ pdf-Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ñ‚Ð¾Ð¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ðµ
          PDF_FILE=$(git diff-tree --no-commit-id --name-only -r "$LAST_APPROVED_COMMIT" -- "docs/*.pdf" | head -n 1 || true)

          if [ -z "$PDF_FILE" ]; then
            echo "No PDF file found in approved commit."
            echo "path=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Using PDF file: $PDF_FILE"
          echo "path=$PDF_FILE" >> $GITHUB_OUTPUT

      - name: Ensure PDF exists
        if: steps.pdf.outputs.path == ''
        run: |
          echo "No approved PDF to send. Skipping DocuSign step."
          exit 0

      - name: Show selected PDF
        if: steps.pdf.outputs.path != ''
        run: |
          echo "Selected PDF: ${{ steps.pdf.outputs.path }}"
          ls -lh "${{ steps.pdf.outputs.path }}"

      - name: Get DocuSign access token (JWT)
        if: steps.pdf.outputs.path != ''
        id: jwt
        env:
          DOCUSIGN_INTEGRATION_KEY: ${{ secrets.DOCUSIGN_INTEGRATION_KEY }}
          DOCUSIGN_USER_ID:        ${{ secrets.DOCUSIGN_USER_ID }}
          DOCUSIGN_AUTH_SERVER:    ${{ secrets.DOCUSIGN_AUTH_SERVER }}
          DOCUSIGN_PRIVATE_KEY:    ${{ secrets.DOCUSIGN_PRIVATE_KEY }}
        run: |
          set -e

          echo "Generating JWT..."

          cat <<EOF > private.key
          ${DOCUSIGN_PRIVATE_KEY}
          EOF
          chmod 600 private.key

          NOW=$(date +%s)
          EXP=$((NOW + 3600))

          HEADER='{"alg":"RS256","typ":"JWT"}'
          PAYLOAD="{\"iss\":\"${DOCUSIGN_INTEGRATION_KEY}...\",\"scope\":\"signature impersonation\",\"exp\":${EXP}}"

          b64url() {
            openssl base64 -e -A | tr '+/' '-_' | tr -d '='
          }

          HEADER_B64=$(printf '%s' "$HEADER" | b64url)
          PAYLOAD_B64=$(printf '%s' "$PAYLOAD" | b64url)

          SIGNING_INPUT="${HEADER_B64}.${PAYLOAD_B64}"

          SIGNATURE=$(printf '%s' "$SIGNING_INPUT" | \
            openssl dgst -sha256 -sign private.key | b64url)

          JWT="${SIGNING_INPUT}.${SIGNATURE}"

          echo "Requesting access token from DocuSign..."

          RESPONSE=$(curl -sS --request POST "https://${DOCUSIGN_AUTH_SERVER}/oauth/token" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer" \
            --data-urlencode "assertion=${JWT}")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Failed to obtain access token"
            echo "$RESPONSE"
            exit 1
          fi

          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: Convert PDF to Base64
        if: steps.pdf.outputs.path != ''
        id: pdf_b64
        run: |
          set -e

          PDF_PATH="${{ steps.pdf.outputs.path }}"

          echo "Converting PDF to Base64: $PDF_PATH"

          base64 -w0 "$PDF_PATH" > pdf_base64.txt

          PDF_B64=$(cat pdf_base64.txt)

          echo "base64=$PDF_B64" >> $GITHUB_OUTPUT

      - name: Send PDF to DocuSign
        if: steps.pdf.outputs.path != ''
        env:
          DOCUSIGN_ACCOUNT_ID:  ${{ secrets.DOCUSIGN_ACCOUNT_ID }}
          DOCUSIGN_BASE_PATH:   ${{ secrets.DOCUSIGN_BASE_PATH }}
          DOCUSIGN_SIGNER_EMAIL:${{ secrets.DOCUSIGN_SIGNER_EMAIL }}
          DOCUSIGN_SIGNER_NAME: ${{ secrets.DOCUSIGN_SIGNER_NAME }}
          ACCESS_TOKEN:         ${{ steps.jwt.outputs.access_token }}
        run: |
          set -e

          echo "Preparing to send envelope to DocuSign..."

          PDF_B64="${{ steps.pdf_b64.outputs.base64 }}"
          DOC_NAME=$(basename "${{ steps.pdf.outputs.path }}")

          REQUEST_BODY=$(jq -n \
            --arg account_id "$DOCUSIGN_ACCOUNT_ID" \
            --arg doc_b64 "$PDF_B64" \
            --arg doc_name "$DOC_NAME" \
            --arg signer_email "$DOCUSIGN_SIGNER_EMAIL" \
            --arg signer_name "$DOCUSIGN_SIGNER_NAME" \
            '{
              emailSubject: "Please sign the approved document",
              documents: [{
                documentBase64: $doc_b64,
                name: $doc_name,
                fileExtension: "pdf",
                documentId: "1"
              }],
              recipients: {
                signers: [{
                  email: $signer_email,
                  name: $signer_name,
                  recipientId: "1",
                  routingOrder: "1",
                  tabs: {
                    signHereTabs: [{
                      documentId: "1",
                      pageNumber: "1",
                      xPosition: "100",
                      yPosition: "150"
                    }]
                  }
                }]
              },
              status: "sent"
            }')

          echo "Sending envelope to DocuSign..."

          RESPONSE=$(curl -sS --request POST \
            "https://${DOCUSIGN_BASE_PATH}/restapi/v2.1/accounts/${DOCUSIGN_ACCOUNT_ID}/envelopes" \
            --header "Authorization: Bearer ${ACCESS_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$REQUEST_BODY")

          echo "DocuSign response:"
          echo "$RESPONSE"

          ENVELOPE_ID=$(echo "$RESPONSE" | jq -r '.envelopeId')

          if [ -z "$ENVELOPE_ID" ] || [ "$ENVELOPE_ID" = "null" ]; then
            echo "Failed to create envelope"
            echo "$RESPONSE"
            exit 1
          fi

          echo "âœ… Envelope created: $ENVELOPE_ID"
          echo "ðŸ“§ Email sent to: $DOCUSIGN_SIGNER_NAME <$DOCUSIGN_SIGNER_EMAIL>"

      - name: Cleanup
        if: always()
        run: rm -f pdf_base64.txt private.key || true
