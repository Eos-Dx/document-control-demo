name: Send approved PDF to DocuSign

on:
  push:
    branches:
      - main
    paths:
      - "docs/*.pdf"
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - "docs/*.pdf"
  workflow_dispatch:
    inputs:
      pdf_file:
        description: 'Specific PDF file to send (e.g., SOP-001.pdf)'
        required: false
        type: string

jobs:
  send_to_docusign:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Find changed PDFs
        id: find_pdfs
        run: |
          set -e

          echo "Event: ${{ github.event_name }}"
          echo "SHA: $GITHUB_SHA"

          # 1) Manual trigger - single file
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.pdf_file }}" ]; then
            PDF_PATH="docs/${{ github.event.inputs.pdf_file }}"
            if [ -f "$PDF_PATH" ]; then
              echo "Manual trigger: using $PDF_PATH"
              echo "$PDF_PATH" > pdf_files.txt
              exit 0
            else
              echo "Error: file not found: $PDF_PATH"
              exit 1
            fi
          fi

          # 2) Automatic trigger - find all changed PDFs
          echo "Looking for changed PDFs in commit $GITHUB_SHA..."

          FILES=$(git diff-tree --no-commit-id --name-only -r "$GITHUB_SHA" | grep "^docs/.*\.pdf$" || true)

          if [ -z "$FILES" ]; then
            echo "No changed PDFs detected."
            # Fallback: check if any PDFs exist
            if ls docs/*.pdf 1> /dev/null 2>&1; then
              LATEST=$(ls -t docs/*.pdf | head -n 1)
              echo "No git changes, using most recent: $LATEST"
              echo "$LATEST" > pdf_files.txt
              exit 0
            else
              echo "No PDFs found."
              touch pdf_files.txt  # Empty file
              exit 0
            fi
          fi

          # Save all changed PDFs to file
          echo "$FILES" > pdf_files.txt

          echo "Changed PDFs:"
          cat pdf_files.txt

          COUNT=$(wc -l < pdf_files.txt)
          echo "Total PDFs to process: $COUNT"

      - name: Process each PDF and send to DocuSign
        env:
          DOCUSIGN_INTEGRATION_KEY: ${{ secrets.DOCUSIGN_INTEGRATION_KEY }}
          DOCUSIGN_USER_ID: ${{ secrets.DOCUSIGN_USER_ID }}
          DOCUSIGN_AUTH_SERVER: ${{ secrets.DOCUSIGN_AUTH_SERVER }}
          DOCUSIGN_PRIVATE_KEY: ${{ secrets.DOCUSIGN_PRIVATE_KEY }}
          DOCUSIGN_BASE_URI: ${{ secrets.DOCUSIGN_BASE_URI }}
          DOCUSIGN_ACCOUNT_ID: ${{ secrets.DOCUSIGN_ACCOUNT_ID }}
          DOCUSIGN_SIGNER_EMAIL: ${{ secrets.DOCUSIGN_SIGNER_EMAIL }}
          DOCUSIGN_SIGNER_NAME: ${{ secrets.DOCUSIGN_SIGNER_NAME }}
        run: |
          set -e

          if [ ! -s pdf_files.txt ]; then
            echo "No PDFs to process"
            exit 0
          fi

          echo "=== Processing PDFs for DocuSign ==="

          TOTAL=$(wc -l < pdf_files.txt)
          CURRENT=0
          SUCCESS=0
          FAILED=0

          while IFS= read -r PDF_PATH; do
            CURRENT=$((CURRENT + 1))

            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Processing [$CURRENT/$TOTAL]: $PDF_PATH"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            if [ ! -f "$PDF_PATH" ]; then
              echo "‚ùå ERROR: File not found: $PDF_PATH"
              FAILED=$((FAILED + 1))
              continue
            fi

            FILENAME=$(basename "$PDF_PATH")

            # Generate JWT for this document
            echo "üîê Generating JWT..."

            echo "$DOCUSIGN_PRIVATE_KEY" > private.key
            chmod 600 private.key

            NOW=$(date +%s)
            EXP=$((NOW + 3600))

            HEADER='{"alg":"RS256","typ":"JWT"}'
            PAYLOAD="{\"iss\":\"${DOCUSIGN_INTEGRATION_KEY}\",\"sub\":\"${DOCUSIGN_USER_ID}\",\"aud\":\"${DOCUSIGN_AUTH_SERVER}\",\"scope\":\"signature impersonation\",\"exp\":${EXP}}"

            b64url() {
              openssl base64 -e -A | tr '+/' '-_' | tr -d '='
            }

            HEADER_B64=$(printf '%s' "$HEADER" | b64url)
            PAYLOAD_B64=$(printf '%s' "$PAYLOAD" | b64url)
            SIGNING_INPUT="${HEADER_B64}.${PAYLOAD_B64}"
            SIGNATURE=$(printf '%s' "$SIGNING_INPUT" | openssl dgst -sha256 -sign private.key | b64url)
            JWT="${SIGNING_INPUT}.${SIGNATURE}"

            echo "üåê Getting access token..."

            RESPONSE=$(curl -sS --request POST "https://${DOCUSIGN_AUTH_SERVER}/oauth/token" \
              --header "Content-Type: application/x-www-form-urlencoded" \
              --data-urlencode "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer" \
              --data-urlencode "assertion=${JWT}")

            ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

            if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
              echo "‚ùå Failed to obtain access token for $FILENAME"
              echo "$RESPONSE"
              FAILED=$((FAILED + 1))
              rm -f private.key
              continue
            fi

            rm -f private.key

            # Encode PDF
            echo "üìÑ Encoding PDF to base64..."
            B64=$(base64 -w0 "$PDF_PATH")

            # Create envelope
            echo "üì§ Creating DocuSign envelope..."

            PAYLOAD=$(jq -n \
              --arg subject "Please sign: $FILENAME" \
              --arg doc_b64 "$B64" \
              --arg doc_name "$FILENAME" \
              --arg signer_email "$DOCUSIGN_SIGNER_EMAIL" \
              --arg signer_name "$DOCUSIGN_SIGNER_NAME" \
              '{
                emailSubject: $subject,
                documents: [{
                  documentBase64: $doc_b64,
                  name: $doc_name,
                  fileExtension: "pdf",
                  documentId: "1"
                }],
                recipients: {
                  signers: [{
                    email: $signer_email,
                    name: $signer_name,
                    recipientId: "1",
                    routingOrder: "1",
                    tabs: {
                      signHereTabs: [{
                        documentId: "1",
                        pageNumber: "1",
                        xPosition: "100",
                        yPosition: "100"
                      }]
                    }
                  }]
                },
                status: "sent"
              }')

            ENVELOPE_RESPONSE=$(curl --silent --show-error --write-out "\nHTTP_CODE:%{http_code}" \
              --request POST \
              --url "${DOCUSIGN_BASE_URI}/restapi/v2.1/accounts/${DOCUSIGN_ACCOUNT_ID}/envelopes" \
              --header "Authorization: Bearer ${ACCESS_TOKEN}" \
              --header "Content-Type: application/json" \
              --data "$PAYLOAD")

            HTTP_CODE=$(echo "$ENVELOPE_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            BODY=$(echo "$ENVELOPE_RESPONSE" | sed '/HTTP_CODE:/d')

            if [ "$HTTP_CODE" != "201" ]; then
              echo "‚ùå Failed to create envelope for $FILENAME (HTTP $HTTP_CODE)"
              echo "Response: $BODY"
              FAILED=$((FAILED + 1))
              continue
            fi

            ENVELOPE_ID=$(echo "$BODY" | jq -r '.envelopeId')

            if [ -z "$ENVELOPE_ID" ] || [ "$ENVELOPE_ID" = "null" ]; then
              echo "‚ùå Failed to extract envelope ID for $FILENAME"
              FAILED=$((FAILED + 1))
              continue
            fi

            echo "‚úÖ SUCCESS: Envelope created for $FILENAME"
            echo "   Envelope ID: $ENVELOPE_ID"
            echo "   Document: $FILENAME"
            echo "   Signer: $DOCUSIGN_SIGNER_NAME <$DOCUSIGN_SIGNER_EMAIL>"

            SUCCESS=$((SUCCESS + 1))

          done < pdf_files.txt

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä SUMMARY"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Total PDFs processed: $TOTAL"
          echo "‚úÖ Successful: $SUCCESS"
          echo "‚ùå Failed: $FAILED"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          if [ "$FAILED" -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: Some envelopes failed to create"
            echo "Check logs above for details"
            exit 1
          fi

          echo "‚úÖ All envelopes created successfully!"

      - name: Cleanup
        if: always()
        run: rm -f pdf_files.txt private.key || true